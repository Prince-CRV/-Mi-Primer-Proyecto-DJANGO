services:
  - type: web
    name: mi-primer-django
    env: python
    plan: free
    buildCommand: |
      python -m pip install --upgrade pip
      pip install -r app/requirements.txt
      # 1. Borramos la DB actual para evitar el conflicto de historial
      rm -f app/db.sqlite3
      # 2. Borramos archivos de migración viejos (excepto __init__.py) para empezar limpio
      find . -path "*/migrations/*.py" -not -name "__init__.py" -delete
      # 3. Creamos migraciones nuevas basadas en tus modelos actuales
      python app/manage.py makemigrations
      # 4. Aplicamos las migraciones a la DB nueva
      python app/manage.py migrate
      # 5. Recolectamos estáticos
      python app/manage.py collectstatic --noinput
    startCommand: "gunicorn --chdir app config.wsgi:application"
    envVars:
      - key: PYTHON_VERSION
        value: 3.12.8
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings
      - key: SECRET_KEY
        generateValue: true
